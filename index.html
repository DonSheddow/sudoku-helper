<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>


<head>
<meta charset="utf-8"/>

<style>

#sudoku-grid {
  display: inline-block;
  border: 3px solid black;
  margin: 2em;
}

#sudoku-grid span {
  display: inline-block;
}

.sudoku-block {
  border-collapse: collapse;
}

.sudoku-cell {
  border: 1px solid grey;
  height: 42px;
  width: 42px;
}

.sudoku-cell__input {
  border: none;
  text-align: center;
  box-sizing: border-box;
  width: 100%;
  font-size: 26px;
}

</style>

<script>

function isNumeric(n) {
  return !isNaN(parseFloat(n)) && isFinite(n);
}

function json_serialize_sudoku() {
    var root = document.getElementById("sudoku-grid");
    var cells = document.getElementsByClassName("sudoku-cell__input");
    var rows = new Array(9).fill("");
    for (var i=0; i<cells.length; i++) {
        var index = 3*Math.floor(i/27) + (Math.floor(i/3) % 3);
        if (cells[i].value.trim() != "") {
            rows[index] += cells[i].value + ',';
        }
        else {
            rows[index] += "_" + ',';
        }
    }
    
    for (var i=0; i<rows.length; i++){
        rows[i] = rows[i].substring(0, rows[i].length-1);
    }
    
    return JSON.stringify(rows);
}

function unserialize_sudoku(s) {
    var root = document.getElementById("sudoku-grid");
    var cells = document.getElementsByClassName("sudoku-cell__input");
    var rows = s.trim().split('\n');
    for (var i=0; i<rows.length; i++) {
        var numbers = rows[i].split(',');
        for (var j=0; j<numbers.length; j++) {
            var index = 27*Math.floor(i/3) + 3*(i % 3) + 9*Math.floor(j/3) + j % 3;
            console.log(index);
            if (numbers[j] == "_") {
                cells[index].value = "";
            }
            else {
                cells[index].value = numbers[j];
            }
        }
    }
}

function create_sudoku_block() {
    var root = document.createElement("table");
    root.classList.add("sudoku-block");
    for (var i=0; i<3; i++) {
        var row = document.createElement("tr");
        for (var j=0; j<3; j++) {
            var column = document.createElement("td");
            column.classList.add("sudoku-cell");
            var input = document.createElement("input");
            input.classList.add("sudoku-cell__input");
            input.type = "text";
            column.appendChild(input);
            row.appendChild(column);
        }
        root.appendChild(row);
    }
    return root;
}

function create_sudoku_grid() {
    var root = document.getElementById("sudoku-grid");
    for (var i=0; i<3; i++) {
        var blockrow = document.createElement("div");
        for (var j=0; j<3; j++) {
            var block = document.createElement("span");
            block.appendChild(create_sudoku_block());
            blockrow.appendChild(block);
        }
        root.appendChild(blockrow);
    }
}

function send_msg() {
    document.getElementById("message-box").innerHTML = "loading...";
//    var msg = document.getElementById("msg-input").value;
    var msg = json_serialize_sudoku();
    socket.send(msg);
}

var socket = new WebSocket("ws://localhost:3012");
socket.onmessage = function (event) {
    if (event.data.length < 20) {
        document.getElementById("message-box").innerHTML = event.data;
    }
    else {
    //    document.getElementById("message-box").innerHTML = event.data.slice(0, 15) + "[...]";
        document.getElementById("message-box").innerHTML = event.data.replace(/(?:\r\n|\r|\n)/g, '<br />');
        unserialize_sudoku(event.data);
    }
}

</script>

</head>


<body onload="create_sudoku_grid()">

<h3 id="message-box"></h3>

<input id="msg-input" type="text"></input>
<button onclick="send_msg()">Submit</button>

<div>
<div id="sudoku-grid">
</div>
</div>

</body>

</html>
